<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home Inventory</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 1em; }
    input, select, button { padding: 0.5em; margin: 0.2em 0; width: 100%; box-sizing: border-box; }
    .item { border-bottom: 1px solid #ccc; padding: 0.5em 0; }
    .item-buttons { display: flex; gap: 0.5em; margin-top: 0.5em; }
    .item-buttons button { flex: 1; }
    .group-heading { font-weight: bold; margin-top: 1em; background: #eee; padding: 0.5em; }
  </style>
</head>
<body>
  <h1>üè† Home Inventory</h1>

  <h2>Add / Edit Item</h2>
  <form id="itemForm">
    <input type="text" id="name" placeholder="Item Name" required />

    <select id="category">
      <option value="">Select Category</option>
      <option value="Kids">Kids</option>
      <option value="Grown ups">Grown ups</option>
      <option value="Seasonal">Seasonal</option>
      <option value="Other">Other</option>
    </select>

    <input type="number" id="quantity" placeholder="Quantity" />

    <select id="room">
      <option value="">Select Room</option>
      <option value="Living Room">Living Room</option>
      <option value="Adult Bedroom">Adult Bedroom</option>
      <option value="Kids Bedroom">Kids Bedroom</option>
      <option value="Office/Guest Room">Office/Guest Room</option>
      <option value="Hallway">Hallway</option>
      <option value="Entryway">Entryway</option>
      <option value="Balcony">Balcony</option>
      <option value="Kitchen">Kitchen</option>
      <option value="Bathroom">Bathroom</option>
      <option value="Dining Room">Dining Room</option>
      <option value="Basement">Basement</option>
    </select>

    <select id="container">
      <option value="">Select Container</option>
    </select>

    <input type="text" id="spot" placeholder="Spot" />
    <input type="text" id="notes" placeholder="Notes" />
    <button type="submit">Add / Update</button>
  </form>

  <h2>Search</h2>
  <input type="text" id="searchBox" placeholder="Search item or keyword" />

  <h3>Filter by Location</h3>
  <select id="roomFilter">
    <option value="">All Rooms</option>
    <option value="Living Room">Living Room</option>
    <option value="Adult Bedroom">Adult Bedroom</option>
    <option value="Kids Bedroom">Kids Bedroom</option>
    <option value="Office/Guest Room">Office/Guest Room</option>
    <option value="Hallway">Hallway</option>
    <option value="Entryway">Entryway</option>
    <option value="Balcony">Balcony</option>
    <option value="Kitchen">Kitchen</option>
    <option value="Bathroom">Bathroom</option>
    <option value="Dining Room">Dining Room</option>
    <option value="Basement">Basement</option>
  </select>
  <select id="containerFilter">
    <option value="">All Containers</option>
  </select>
  <input type="text" id="spotFilter" placeholder="Filter by Spot" />

  <h2>Inventory</h2>
  <div id="inventory"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzE2GohareqTJZpOMWtxhWYgIi3psrdKSubMQkNzwTUMdyeEmYr9G_2kNn0JmuePS87HA/exec';

    const containerOptions = {
      "Living Room": ["Couch", "Dresser", "Bookshelf", "Green Console"],
      "Adult Bedroom": ["Wire closet", "Ben's dresser", "Gizem's dresser", "Built in closet"],
      "Kids Bedroom": ["White closet", "Built in closet", "Dresser", "Cloth dresser"],
      "Office/Guest Room": ["Built in closet", "Wooden tall dresser"],
      "Hallway": ["Closet"],
      "Entryway": ["Shoe rack", "Closet"],
      "Balcony": [],
      "Kitchen": ["Cabinets", "White Ikea Cabinet", "White Coffee Bar"],
      "Bathroom": ["Mirror cabinet", "White cabinet", "Under sink cabinet"],
      "Dining Room": ["Hutch", "Table", "Desk", "Nehir's containers"],
      "Basement": []
    };

    function populateContainerDropdown(room, selectId = 'container') {
      const containerSelect = document.getElementById(selectId);
      containerSelect.innerHTML = '<option value="">' + (selectId === 'containerFilter' ? 'All Containers' : 'Select Container') + '</option>';
      (containerOptions[room] || []).forEach(container => {
        const option = document.createElement('option');
        option.value = container;
        option.textContent = container;
        containerSelect.appendChild(option);
      });
    }

    document.getElementById('room').addEventListener('change', (e) => {
      populateContainerDropdown(e.target.value);
    });

    document.getElementById('roomFilter').addEventListener('change', (e) => {
      populateContainerDropdown(e.target.value, 'containerFilter');
      renderItems(window._items || []);
    });

    async function fetchItems() {
      const res = await fetch(API_URL);
      if (!res.ok) {
        alert('Failed to load data from Google Sheets.');
        return [];
      }
      return res.json();
    }

    async function addOrUpdateItem(item) {
      item["Last Modified"] = new Date().toISOString();
      const res = await fetch(`${API_URL}?action=add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(item)
      });
      if (!res.ok) alert('Failed to add/update item.');
      return res;
    }

    async function deleteItem(name) {
      const res = await fetch(`${API_URL}?action=delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ "Item Name": name })
      });
      if (!res.ok) alert('Failed to delete item.');
      return res;
    }

    function renderItems(items) {
      const filter = document.getElementById('searchBox').value.toLowerCase();
      const roomFilter = document.getElementById('roomFilter').value.toLowerCase();
      const containerFilter = document.getElementById('containerFilter').value.toLowerCase();
      const spotFilter = document.getElementById('spotFilter').value.toLowerCase();

      const container = document.getElementById('inventory');
      container.innerHTML = '';

      const filtered = items.filter(i => {
        const matchText = Object.values(i).some(val => val?.toString().toLowerCase().includes(filter));
        const matchRoom = !roomFilter || (i.Room || '').toLowerCase() === roomFilter;
        const matchContainer = !containerFilter || (i.Container || '').toLowerCase() === containerFilter;
        const matchSpot = !spotFilter || (i.Spot || '').toLowerCase().includes(spotFilter);
        return matchText && matchRoom && matchContainer && matchSpot;
      });

      const grouped = {};
      for (const item of filtered) {
        const key = `${item.Room || 'Uncategorized'} ‚Üí ${item.Container || 'No Container'}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(item);
      }

      for (const group in grouped) {
        const heading = document.createElement('div');
        heading.className = 'group-heading';
        heading.textContent = group;
        container.appendChild(heading);

        for (const item of grouped[group]) {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <strong>${item["Item Name"] || '(No name)'}</strong> (${item.Quantity || 1})<br />
            <em>${item.Notes || ''}</em><br />
            <small>Last Modified: ${item["Last Modified"] || 'N/A'}</small>
            <div class="item-buttons">
              <button onclick="fillForm(${JSON.stringify(item).replace(/"/g, '&quot;')})">Edit</button>
              <button onclick="deleteAndRefresh('${item["Item Name"]}')">Delete</button>
            </div>
          `;
          container.appendChild(div);
        }
      }
    }

    function fillForm(item) {
      document.getElementById('name').value = item["Item Name"] || '';
      document.getElementById('category').value = item["Category"] || '';
      document.getElementById('quantity').value = item["Quantity"] || '';
      document.getElementById('room').value = item["Room"] || '';
      populateContainerDropdown(item["Room"] || '');
      document.getElementById('container').value = item["Container"] || '';
      document.getElementById('spot').value = item["Spot"] || '';
      document.getElementById('notes').value = item["Notes"] || '';
    }

    async function deleteAndRefresh(name) {
      if (!confirm(`Delete item "${name}"?`)) return;
      await deleteItem(name);
      loadAndRender();
    }

    async function loadAndRender() {
      const items = await fetchItems();
      window._items = items;
      renderItems(items);
    }

    document.getElementById('itemForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const item = {
        "Item Name": document.getElementById('name').value,
        "Category": document.getElementById('category').value,
        "Quantity": document.getElementById('quantity').value,
        "Room": document.getElementById('room').value,
        "Container": document.getElementById('container').value,
        "Spot": document.getElementById('spot').value,
        "Notes": document.getElementById('notes').value
      };
      await addOrUpdateItem(item);
      loadAndRender();
      document.getElementById('itemForm').reset();
    });

    document.getElementById('searchBox').addEventListener('input', () => {
      renderItems(window._items || []);
    });
    document.getElementById('containerFilter').addEventListener('change', () => {
      renderItems(window._items || []);
    });
    document.getElementById('spotFilter').addEventListener('input', () => {
      renderItems(window._items || []);
    });

    loadAndRender();
  </script>
</body>
</html>
